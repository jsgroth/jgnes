<!DOCTYPE html>
<html lang="en">
    <head>
        <title>jgnes web</title>
        <meta charset="UTF-8">
        <style>
            body {
                background-color: black;
            }

            canvas.grayed-out {
                opacity: 0.5;
            }

            #jgnes-wasm {
                width: 878px;
                margin-bottom: 15px;
                margin-left: auto;
                margin-right: auto;
            }

            #jgnes-wasm.grayed-out {
                background-color: white;
            }

            #jgnes-web-text {
                margin-left: auto;
                margin-right: auto;
                margin-bottom: 15px;
                width: 878px;
                font-size: 24px;
                text-align: center;
                color: white;
            }

            #rom-file-name {
                margin-bottom: 6px;
            }

            #jgnes-config {
                width: 1000px;
                margin-left: auto;
                margin-right: auto;
                color: white;
            }

            #loading-text {
                font-size: 60px;
                text-align: center;
                margin-left: auto;
                margin-right: auto;
                color: white;
            }

            #info-text {
                width: 672px;
                margin-left: auto;
                margin-right: auto;
                color: white;
            }
        </style>
    </head>
    <body>
        <div id="jgnes-web-text">jgnes web</div>
        <div id="loading-text">Loading...</div>
        <div id="jgnes-wasm"></div>
        <div id="jgnes-config-and-info" hidden>
            <form id="jgnes-config">
                <div id="jgnes-init">
                    <div id="rom-file-name"></div>
                    <input id="jgnes-init-button" type="button" value="Open NES ROM file">
                    <input id="jgnes-reset-button" type="button" value="Reset" disabled>
                    <input id="jgnes-download-sav-button" class="save-button" type="button" value="Download save file" disabled>
                    <input id="jgnes-upload-sav-button" class="save-button" type="button" value="Upload save file and reset" disabled>
                </div>
                <fieldset>
                    <legend>Aspect ratio</legend>

                    <input type="radio" id="aspect-ntsc" name="aspect-ratio" value="Ntsc" checked>
                    <label for="aspect-ntsc">NTSC</label>

                    <input type="radio" id="aspect-square-pixels" name="aspect-ratio" value="SquarePixels">
                    <label for="aspect-square-pixels">Square pixels</label>
                </fieldset>
                <fieldset>
                    <legend>Image filtering</legend>

                    <input type="radio" id="filter-nearest" name="image-filter" value="NearestNeighbor" checked>
                    <label for="filter-nearest">Nearest neighbor</label>

                    <input type="radio" id="filter-linear" name="image-filter" value="Linear">
                    <label for="filter-linear">Linear interpolation</label>

                    <input type="radio" id="filter-linear-2x" name="image-filter" value="Linear2x">
                    <label for="filter-linear-2x">Linear interpolation (2x scaled)</label>

                    <input type="radio" id="filter-linear-3x" name="image-filter" value="Linear3x">
                    <label for="filter-linear-3x">Linear interpolation (3x scaled)</label>
                </fieldset>
                <fieldset>
                    <legend>Overscan</legend>

                    <input type="checkbox" id="overscan-left" name="overscan-left">
                    <label for="overscan-left">Left</label>

                    <input type="checkbox" id="overscan-right" name="overscan-right">
                    <label for="overscan-right">Right</label>

                    <input type="checkbox" id="overscan-top" name="overscan-top">
                    <label for="overscan-top">Top</label>

                    <input type="checkbox" id="overscan-bottom" name="overscan-bottom">
                    <label for="overscan-bottom">Bottom</label>
                </fieldset>
                <fieldset>
                    <legend>Audio</legend>

                    <input type="checkbox" id="audio-enabled" name="audio-enabled" checked>
                    <label for="audio-enabled">Audio enabled</label>

                    <input type="checkbox" id="audio-sync-enabled" name="audio-sync-enabled" checked>
                    <label for="audio-sync-enabled">Audio sync enabled</label>

                    <input type="checkbox" id="silence-triangle-ultrasonic" name="silence-triangle-ultrasonic">
                    <label for="silence-triangle-ultrasonic">Silence ultrasonic triangle channel output (reduce pops)</label>
                </fieldset>
            </form>
            <div id="info-text">
                <p>Input keys</p>
                <ul>
                    <li>Up: <input type="button" id="up-key" class="input-config" value="Up"></li>
                    <li>Left: <input type="button" id="left-key" class="input-config" value="Left"></li>
                    <li>Right: <input type="button" id="right-key" class="input-config" value="Right"></li>
                    <li>Down: <input type="button" id="down-key" class="input-config" value="Down"></li>
                    <li>A: <input type="button" id="a-key" class="input-config" value="Z"></li>
                    <li>B: <input type="button" id="b-key" class="input-config" value="X"></li>
                    <li>Start: <input type="button" id="start-key" class="input-config" value="Return"></li>
                    <li>Select: <input type="button" id="select-key" class="input-config" value="RShift"></li>
                </ul>
                <p>Download the native version and/or source code: <a href="https://github.com/jsgroth/jgnes">https://github.com/jsgroth/jgnes</a></p>
            </div>
        </div>
        <script type="module">
            import init, { b64_to_bytes, run, JgnesWebConfig, NesButton } from "./pkg/jgnes_web.js";
            await init();

            let config = new JgnesWebConfig();
            let running = false;

            document.querySelectorAll("input[name='aspect-ratio']").forEach((element) => {
                element.checked = element.getAttribute("value") === config.get_aspect_ratio();

                element.addEventListener("click", () => {
                    let aspectRatio = document.querySelector("input[name='aspect-ratio']:checked").value;
                    config.set_aspect_ratio(aspectRatio);
                });
            });

            document.querySelectorAll("input[name='image-filter']").forEach((element) => {
                element.checked = element.getAttribute("value") === config.get_filter_mode();

                element.addEventListener("click", () => {
                    let filterMode = document.querySelector("input[name='image-filter']:checked").value;
                    config.set_filter_mode(filterMode);
                });
            });

            document.getElementById("overscan-left").checked = config.get_overscan_left();
            document.getElementById("overscan-left").addEventListener("click", (event) => {
                config.set_overscan_left(event.target.checked);
            });

            document.getElementById("overscan-right").checked = config.get_overscan_right();
            document.getElementById("overscan-right").addEventListener("click", (event) => {
                config.set_overscan_right(event.target.checked);
            });

            document.getElementById("overscan-top").checked = config.get_overscan_top();
            document.getElementById("overscan-top").addEventListener("click", (event) => {
                config.set_overscan_top(event.target.checked);
            });

            document.getElementById("overscan-bottom").checked = config.get_overscan_bottom();
            document.getElementById("overscan-bottom").addEventListener("click", (event) => {
                config.set_overscan_bottom(event.target.checked);
            });

            document.getElementById("audio-enabled").checked = config.get_audio_enabled();
            document.getElementById("audio-enabled").addEventListener("click", (event) => {
                config.set_audio_enabled(event.target.checked);
            });

            document.getElementById("audio-sync-enabled").checked = config.get_audio_sync_enabled();
            document.getElementById("audio-sync-enabled").addEventListener("click", (event) => {
                config.set_audio_sync_enabled(event.target.checked);
            });

            document.getElementById("silence-triangle-ultrasonic").checked = config.get_silence_ultrasonic_triangle_output();
            document.getElementById("silence-triangle-ultrasonic").addEventListener("click", (event) => {
                config.set_silence_ultrasonic_triangle_output(event.target.checked);
            });

            document.querySelectorAll("input.input-config").forEach((element) => {
                element.addEventListener("click", (event) => {
                    let button = {
                        "up-key": NesButton.Up,
                        "left-key": NesButton.Left,
                        "right-key": NesButton.Right,
                        "down-key": NesButton.Down,
                        "a-key": NesButton.A,
                        "b-key": NesButton.B,
                        "start-key": NesButton.Start,
                        "select-key": NesButton.Select,
                    }[event.target.id];

                    config.reconfigure_input(button);

                    document.querySelectorAll("input.input-config").forEach((element) => {
                        element.disabled = true;
                    });

                    let canvas = document.querySelector("canvas");
                    canvas.classList.add("grayed-out");
                    document.getElementById("jgnes-wasm").classList.add("grayed-out");

                    // Focus canvas so the user doesn't have to go click on it
                    canvas.focus();
                });
            });

            document.getElementById("jgnes-init-button").addEventListener("click", () => {
                if (!running) {
                    document.getElementById("jgnes-reset-button").disabled = false;
                    running = true;
                }

                config.open_new_file();
            });

            document.getElementById("jgnes-reset-button").addEventListener("click", () => {
                config.reset_emulator();
                document.querySelector("canvas").focus();
            });

            document.getElementById("jgnes-download-sav-button").addEventListener("click", () => {
                let currentFilename = config.get_current_filename();
                let savB64 = localStorage.getItem(currentFilename);
                if (savB64 !== null) {
                    let savBytes = b64_to_bytes(savB64);
                    if (savBytes !== undefined) {
                        let savFilename = currentFilename.replace(/\.nes$/, ".sav");

                        let a = document.createElement("a");
                        a.href = window.URL.createObjectURL(new Blob([savBytes], {type: "application/octet-stream"}));
                        a.download = savFilename;

                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        alert(`Save file for '${currentFilename}' is invalid`);
                    }
                } else {
                    alert(`No save file found for '${currentFilename}'; game most likely does not have persistent saves`);
                }
            });

            document.getElementById("jgnes-upload-sav-button").addEventListener("click", () => {
                config.upload_save_file();
            });

            run(config.clone());
        </script>
    </body>
</html>